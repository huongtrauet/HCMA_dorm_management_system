<div class="post_management_list">
  <div class="header" style="display: flex; justify-content: space-between;">
    <div class="header_title">
      <h3>Post Management: </h3>
    </div>
    <div class="header_search">
      <button class="ui icon button" onclick="addPost()">
        <i class="plus icon"></i>
      </button>
      <div class="ui icon input">
        <input type="text" placeholder="Search...">
        <i class="icon">
          <img src="/assets/search.png" style="width: 1rem; height: 1rem; width: 1rem; top: 50%; position: absolute; transform: translateY(-50%);right: 0.7rem;">
        </i> 
      </div>
    </div>
  </div>
  <div class="footer_line" style="height: 1px; background-color: rgba(34,36,38,.15); margin-top: 0.5rem; margin-bottom: 1.5rem"></div>
  <table class="ui very basic selectable table">
    <thead>
      <tr>
        <th>STT</th>
        <th>Tieu de</th>
        <th>Noi dung</th>
        <th>Thoi gian</th>
        <th>Nguoi dang</th>
        <th>Trang thai</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <% @posts.each_with_index do |post, index|%>  
        <tr>
            <td onclick="showPost(<%= post.id %>)"><%= index + 1 %></td>
            <td style="max-width: 25rem" onclick="showPost(<%= post.id %>)">
              <span style="margin: 0 auto; word-wrap: break-word; max-width: 10rem; overflow: hidden; -webkit-line-clamp: 1; -webkit-box-orient: vertical; display: -webkit-box">
                <%= post.title %>
              </span>
            </td onclick="showPost(<%= post.id %>)">
            <td style="max-width: 25rem"onclick="showPost(<%= post.id %>)">
              <span style="margin: 0 auto; word-wrap: break-word; max-width: 20rem; overflow: hidden; -webkit-line-clamp: 1; -webkit-box-orient: vertical; display: -webkit-box">
                <%= post.content.html_safe %>
              </span>
            </td>
            <td onclick="showPost(<%= post.id %>)"><%= post.created_at %></td>
            <td onclick="showPost(<%= post.id %>)"><%= post.writer_name %></td>
            <td onclick="showPost(<%= post.id %>)" id="post_status_<%= post.id%>"><%= post.status%></td>
            <td id="post_actions_<%= post.id%>">
              <% if post.status == "POSTED" %>
                <i class="trash alternate outline icon" id="delete_post_<%= post.id %>" onclick="changePostStatus(<%= post.id %>)"></i>
              <% elsif post.status == "DELETED" %>
                <i class="window restore outline icon" id="delete_post_<%= post.id %>" onclick="changePostStatus(<%= post.id %>)"></i>
              <% end %>
            </td>
         </tr> 
        </tr>
         </tr> 
        <div class="ui long small modal first scrolling" id="show_modal_first_<%= post.id %>">
          <div class="scrolling content" style="padding: 3rem">
            <div class="description">
              <div class="ui header"><h2><%= post.title %></h2></div>
              <%# <div class="content" style=""><img style="width: 50%; margin: 0 auto; display: block;"/></div> %>
              <div class="content" style="margin-top: 2rem"><%= post.content.html_safe %></div>
              <% if post.images.length == 1 %>
              <div class="picture" style="width: 100%; height: 50rem; margin: 0 auto; display: flex">
                <div style="background-image: url(<%= image_path post.images[0].url %>); width: 100%; height: 100%; margin: 0 auto; background-repeat: no-repeat; background-position: top;"></div>
              </div>
              <% elsif post.images.length > 1 %>
                <div class="picture" style="width: 100%; height: 25rem; margin: 0 auto; display: flex">
                  <div style="background-image: url(<%= image_path post.images[0].url %>); width: 50%; height: 100%; margin: 0 auto; background-repeat: no-repeat; background-position: cover; "></div>
                  <div style="width: 50%; height: 100%; position: relative" >
                    <div style="background-image: url(<%= image_path post.images[1].url %>); width: 100%; height: 100%; margin: 0 auto; background-repeat: no-repeat; background-position: cover; "></div>
                    <% if post.images.length > 2 %>
                      <div style="background-color: #000000; opacity: 0.5; position: absolute; top: 0; left: 0; width: 100%; height: 100%">
                      </div>
                      <p style="color: white; top: 50%; left: 50%; transform: translate(-50%, -50%); position: absolute; font-size: 3rem; ">
                        +<%= post.images.length - 2 %>
                      </p>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>   
          </div>
          <div class="actions">
            <button class="ui cancel button">
              Cancel
            </button>
            <div class="ui primary approve button proceed" onclick="">
              Proceed
              <i class="right chevron icon"></i>
            </div>
          </div>
        </div>
        <div class="ui small modal second scrolling" id="show_modal_second_<%= post.id %>">
          <div class="header">
            Edit my post
          </div>
          <%= form_for @post_management, url: {controller: "post_management", action: "update"}  do |f|%>
            <div class="scrolling image content">
              <div class="description">
                <div class="ui form">
                  <%= f.hidden_field :id, value: post.id  %>
                  <div class="field">
                    <%= f.text_field :title,  :value => "#{post.title}", rows: "2"  %>
                  </div>
                  <div class="field">
                    <%= f.text_area :content,  :value => "#{post.content}", id: "editor_#{post.id}" %>
                  </div>
                  <div class="content">
                    <div class="ui special cards" id=""> 
                      <div class="card" style="height: 20rem", id="">
                        <img src="<%= post.images[0].url %>" />
                        <input type="file" (change)="fileEvent($event)" class="inputfile" id="embedpollfileinput" onchange="generatePreviewImage(this)" style="width: 100%; height: 100%"/>
                        <label for="embedpollfileinput" class="ui button" style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center">
                          <i class="ui plus icon"></i>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="actions">
              <button class="ui approve button">
                Cancel
              </button>
              <%= f.submit "Submit", class: "ui primary approve button" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </tbody>
  </table>
</div>

<div class="ui longer modal add">
  <div class="header">
    Create a new post
  </div>
  <%= form_for @post_management, url: {controller: "post_management", action: "create"}, html: { multipart: true }  do |f|%>
    <div class="ui form" style="padding: 1rem">
      <div class="field">
        <%= f.text_area :title, placeholder: "Enter title", rows: "2"  %>
      </div>
      <div class="field">
        <%= f.text_area :content, placeholder: "Enter content", id: "editor" %>
      </div>
      <div class="field" style= "display: flex; justify-content: flex-end;">
        <%= f.text_area :writer_name, placeholder: "Writer", rows: "1", style: "width: 30%" %>
      </div>
      <div class="content">
        <div class="ui special cards" id="preview_image"> 
          <div class="card" style="height: 20rem", id="preview_image_card">
            <%# <input type="file" class="inputfile" id="embedpollfileinput1" onchange="generatePreviewImage(this)" style="width: 100%; height: 100%" multiple="true" accept="image/png, image/jpeg" name="images" /> %>
            <%= f.file_field :images, accept: 'image/png,image/jpeg', class: "inputfile", id: "embedpollfileinput1", onchange: "generatePreviewImage(this)", style: "width: 100%; height: 100%",  multiple: "true" %> 
            <label for="embedpollfileinput1" class="ui button" style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center">
              <i class="ui plus icon"></i>
            </label>
          </div>
        </div>
      </div>
      <div>
        <img id="preview_img" style= "width: 20%;"/>
      </div>
      <div class="actions" style="float: right">
        <button class="ui cancel button">
          Cancel
        </button>
        <%= f.submit "Submit", class: "ui primary approve button" %>
      </div>
    </div>
  <% end %>
</div>

<style>
  .ck-editor__editable_inline {
    min-height: 150px;  
  }
</style>
<script src="https://cdn.ckeditor.com/ckeditor5/25.0.0/classic/ckeditor.js">
</script>
<script>
  $('.special.cards .card .image').dimmer({
    on: 'hover'
  });

  function changePostStatus(post_id) {
    var r = confirm("Press a button!");
    if (r == true) {
      $.ajax({
        type:"POST",
        url:"/manager/post-management/",
        dataType:"json",
        data: {id: post_id},
        success:function(result){
          alert(result.message);
          document.getElementById(`post_status_${post_id}`).innerHTML = result.status;
          document.getElementById(`post_actions_${post_id}`).innerHTML = `<i class='${result.status == 'POSTED' ?  'trash alternate' : 'window restore' } outline icon' onclick='changePostStatus(${post_id})'></i>`;
        }
      })
    } else {

    }
  }

  var isCreated = []
  document.addEventListener("DOMContentLoaded", function(event) { 
      ClassicEditor
        .create( document.querySelector( '#editor' ), {
          toolbar: [ 'heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote', 'imageInsert'],
          heading: {
            options: [
                { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' }
            ]
        }
        })
        .catch( error => {
          console.error( error );
        })
    }
  );

  function showPost(post_id) {
    console.log("show post work");
    $(`#show_modal_first_${post_id}`).modal('show');
    $(`#show_modal_second_${post_id}`)
    .modal('attach events', `#show_modal_first_${post_id} .button.proceed`)
;
    if (isCreated[post_id] != true) {
       ClassicEditor
        .create( document.querySelector( '#editor_' + post_id ), {
          toolbar: [ 'heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote', 'imageInsert'],
          heading: {
            options: [
                { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' }
            ]
        }
        })
        .catch( error => {
          console.error( error );
        })
        isCreated[post_id] = true;
    }
  }

  $('.coupled.modal')
    .modal({
      allowMultiple: false
    })
  ;
  // attach events to buttons
  function addPost() {
    $('.ui.longer.modal.add').modal('show');
  }
  // CKEDITOR.replace('content',{ toolbar :[ ['Subscript','Superscript'] ], height: '35px', width: '100%' });
  console.log(ClassicEditor.builtinPlugins.map( plugin => plugin.pluginName ))

  function convertStringToHtml(str) { 
    return $(str);
  }
  function generatePreviewImage(image){
    var index = 0;
    for (let i = 0; i < image.files.length; i++) {
      $('#preview_image').append(`<div class='card' style="max-height: 20rem" id="image_${index}">
                                <i class="ui window close outline icon" style="position: absolute; top: 0.5rem; right: 0.5rem; cursor: pointer;", onclick="removeImage(this)"></i>
                                <img style="width: 100%; height: 100%;" src='${URL.createObjectURL(image.files[i])}' />
                                </div>`)
    }
    // $('#preview_image').append(`<div class="card" style="height: 20rem", id="preview_image_card">
    //         <input type="file" class="inputfile" id="embedpollfileinput" onchange="generatePreviewImage(this)" style="width: 100%; height: 100%" multiple/>
    //         <label for="embedpollfileinput" class="ui button" style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center">
    //           <i class="ui plus icon"></i>
    //         </label>
    //       </div>`)
    index++;
  }
  function removeImage(_this){
    $(_this).parent().remove();
    console.log($('#embedpollfileinput1').val())
  }

</script>
<style>
.grid.container {
  margin-top: 5em;
}
.inputfile {
	width: 0.1px;
	height: 0.1px;
	opacity: 0;
	overflow: hidden;
	position: absolute;
	z-index: -1;
}
.insert_image:hover {
  background-color: #e0e1e2;
  cursor: pointer;
}
.card {
      width: 30% !important;
      float: left;
    }
</style>