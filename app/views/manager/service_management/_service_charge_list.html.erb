<style>
.filter_item{
  width: 9rem !important;
  min-width: 9rem !important;
  margin-right: 1rem;
}
</style>
<div class="service_charge_list">
  <div class="header" style="display: flex; justify-content: space-between; margin-bottom: 1rem">
    <div class="header_title">
      <h3>Service charge: </h3>
    </div>
  </div>
  <div style="display: flex; justify-content: flex-start">
    <div class="ui selection dropdown filter_item" >
      <input type="hidden" name="room_name_filter" onchange="onHandleFilter(this)">
      <div class="default text">Phong</div>
      <div class="menu">
        <div class="item" data-value="ALL">All</div>
        <% @rooms.each do |r|%>
          <div class="item" data-value="<%= r.id %>"><%= r.room_name %></div>
        <% end %>
      </div>
    </div>
    <div class="ui selection dropdown filter_item">
      <input type="hidden" name="status_filter" onchange="onHandleFilter(this)">
      <div class="default text">Trang thai</div>
      <div class="menu">
        <div class="item" data-value="ALL">All</div>
        <div class="item" data-value="PAID">Paid</div>
        <div class="item" data-value="UNPAID">Unpaid</div>
      </div>
    </div>
    <div class="ui selection dropdown filter_item" id="min_charge">
      <input type="hidden" value="0" name="min_charge" onchange="onHandleFilter(this)">
      <i class="dropdown icon"></i>
      <div class="default text">Min charge</div>
      <div class="menu">
        <div class="item" data-value="ALL">All</div>
        <div class="item" data-value="50000">50000</div>
        <div class="item" data-value="100000">100000</div>
        <div class="item" data-value="200000">200000</div>
        <div class="item" data-value="300000">300000</div>
        <div class="item" data-value="400000">400000</div>
        <div class="item" data-value="500000">500000</div>
      </div>
    </div>
    <div class="ui selection dropdown filter_item" id="max_charge">
      <input type="hidden" value="0" name="max_charge" onchange="onHandleFilter(this)">
      <i class="dropdown icon"></i>
      <div class="default text">Max charge</div>
      <div class="menu">
        <div class="item" data-value="ALL">All</div>
        <div class="item" data-value="50000">50000</div>
        <div class="item" data-value="100000">100000</div>
        <div class="item" data-value="200000">200000</div>
        <div class="item" data-value="300000">300000</div>
        <div class="item" data-value="400000">400000</div>
        <div class="item" data-value="500000">500000</div>
      </div>
    </div>
  </div>
  <div style="min-width: 8px; width: 19rem !important; margin-top: 1rem;" >
    <select id="month_filter" name="month_filter" multiple="" class="ui fluid dropdown" onchange="onHandleFilter(this)">
      <option value="">Month</option>
      <option value="1">Thang 1</option>
      <option value="2">Thang 2</option>
      <option value="3">Thang 3</option>
      <option value="4">Thang 4</option>
      <option value="5">Thang 5</option>
      <option value="6">Thang 6</option>
      <option value="7">Thang 7</option>
      <option value="8">Thang 8</option>
      <option value="9">Thang 9</option>
      <option value="10">Thang 10</option>
      <option value="11">Thang 11</option>
      <option value="12">Thang 12</option>
    </select>
  </div>
   <div class="remind checkbox_col" style="display: none">
    <button class="button" id="myElement" disabled style="float: right; margin: 1rem 1.8rem 1rem 0;" onclick="onclick()">Orange</button>
  </div>
  <table class="ui very basic selectable table">
    <thead>
      <tr>
        <th>STT</th>
        <th>Phong</th>
        <th>Thang</th>
        <th>Tien dien</th>
        <th>Tien nuoc</th>
        <th>Tong</th>
        <th>Trang thai</th>
        <th>Nguoi nop tien</th>
        <th style="display: none" class="checkbox_col">
         <div class="ui checkbox">
            <input type="checkbox" name="example" onchange="selectItem(this) ">
            <label></label>
          </div>
        </th>
      </tr>
    </thead>
    <tbody id="service_charge_table">
      <% @service_charges.each_with_index do |charge, index| %>
        <tr onclick="showServiceChargeInfo(<%= charge.room_id %>, <%= charge.year %>, <%= charge.month %>, <%= charge.id %>, <%= index + 1%>)" id="tr_service_charge_<%= charge.id %>">
          <td><%= index + 1 %></td>
          <td><%= charge.room.room_name %></td>
          <td><%= charge.month %></td>
          <td><%= charge.electricity_price %></td>
          <td><%= charge.water_price %></td>
          <td><%= charge.total_price %></td>
          <td>
            <% if charge.status == "PAID" %>
              <a class="ui teal tag label" style="width: 6.7rem"><%= charge.status %></a>
            <% elsif charge.status == "UNPAID" %>
              <a class="ui red tag label" style="width: 6.7rem"><%= charge.status %></a>
            <% end  %>
          </td>
          <td><%= charge.payer %></td>
          <td style="display: none" class="checkbox_col">
            <div class="ui checkbox">
              <input class="remind_checkbox" type="checkbox" name="example" onchange="onHandleCheckbox(this)">
              <label></label>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <div class="mt-4" style="float: right;">
    <%= paginate @service_charges, turbolinks: false %>
  </div>
</div>

<div class="ui first modal service_charge_info" id="show_info_modal">
  <i class="close icon"></i>
  <div class="header">
      <h3>Service charge</h3>
      <div>
        <p style="margin-bottom: -1rem" id="show_paid_at"></p>
        <p style="float: right; margin-right: 1rem; margin-right: 2.6rem;" class="show_room_name"></p>
        <input type="hidden" name="room_id" id="room_id">
        <input type="hidden" name="charge_id" id="charge_id">
      </div>
  </div>
  <div class="ui header" style="margin-bottom: 2rem; border: none"><%=  %></div>
    <div class="">
      <div class="ui grid">
        <div class="one wide column"></div>
        <div class="five wide column">
          <div class="student-info">
            <div class="ui field">
              <label>Thang:</label>
              <p id="show_month"></p>
            </div>
            <label>Tong tien:</label>
            <p id="show_total_price"></p>
          </div>
        </div>
        <div class="five wide column">
          <div class="student-info">
            <label>Tien dien: </label>
            <p id="show_electricity_price"></p>
            <label>Tien nuoc</label>
            <p id="show_water_price"></p>
          </div>
        </div>
        <div class="five wide column">
          <div class="student-info">
            <label>Trang thai: </label>
            <p>
              <span style="background-color: #f4810b; padding: 6px 10px; color: #fff; border-radius: 5px; font-weight: bold" id="show_status"></span>
            </p>
            <label>Nguoi nop</label>
            <p id="show_payer"></p>
          </div>
        </div>
      </div>
    </div>
    <div class="actions" style="padding: 0.7rem 1rem;">
      <div class="ui black deny button" onclick="closeModal()">
        Cancel
      </div>
      <div class="ui positive right labeled icon button edit">
        Edit
        <i class="arrow right icon"></i>
      </div>
    </div>
</div>

<div class="ui second modal service_charge_info" id="edit_info_modal">
  <i class="close icon"></i>
  <div class="header">
    <h3>Service charge edit</h3>
    <div>
      <p id="paid_at" style="margin-bottom: -1rem"></p>
      <p style="float: right; margin-right: 1rem; margin-right: 2.6rem;" class="show_room_name"></p>
      <input type="hidden" name="charge_index" id="charge_index">
    </div>
  </div>
  <div class="ui header" style="margin-bottom: 2rem; border: none"></div>
  <form class="ui form" style="margin: 0 1.5rem" id="service_charge_edit_form" name="service_charge_edit_form" class="ui form segment">
    <div class="three fields">
      <div class="field">
        <label>Thang</label>
        <input type="text" placeholder="Thang" disabled value="Thang 2" name="month" id="month_edit_field">
      </div>
      <div class="field">
        <label>Tien dien</label>
        <input type="number" placeholder="Tien dien" name="electricity_price" id="electricity_price_edit_field" onkeyup="changePrice()">
      </div>
      <div class="field">
        <label>Trang thai</label>
        <div class="ui selection dropdown">
          <input type="hidden" name="status" id="status_edit_field">
          <i class="dropdown icon"></i>
          <div class="text" style="color: black;" id="selected_item"></div>
          <div class="menu">
            <div class="item" data-value="PAID">PAID</div>
            <div class="item" data-value="UNPAID">UNPAID</div>
          </div>
        </div>
      </div>
    </div>
    <div class="three fields">
      <div class="field">
        <label>Tong tien</label>
        <input type="number" placeholder="Tong tien" name="total_price" id="total_price_edit_field" disabled>
      </div>
      <div class="field">
        <label>Tien nuoc</label>
        <input type="number" placeholder="Tien nuoc" name="water_price" id="water_price_edit_field" onkeyup="changePrice()">
      </div>
      <div class="field">
        <label>Nguoi nop</label>
        <input type="text" placeholder="Nguoi nop" name="payer" id="payer_edit_field">
      </div>
    </div>
    <div class="actions" style="padding: 0.7rem 1rem; float:right; margin-right: 1.5rem">
      <div class="ui black deny button" onclick="closeModal()">
        Cancel
      </div>
      <div class="ui blue submit button">Submit</div>
    </div>
  </form>
</div>

<script>

  $('.ui.dropdown').dropdown();
  // ô vuông chọn 1 bên phải
  function selectItem(event) {
    if (event.checked == true) {
      $('.remind_checkbox').prop('checked', true);
      $('.remind .button').addClass('hover');
    }
    else if (event.checked == false) {
      $('.remind_checkbox').prop('checked', false);
      $('.remind .button').removeClass('hover');
    }
  }
  
  function onHandleCheckbox (event) {
    var checkboxes = $('input:checkbox:checked').length;
    if (checkboxes > 0) {
      $('.remind .button').prop('disabled', false)
      $('.remind .button').addClass('hover');
    }
    else if (checkboxes <= 0)
    {
      $('.remind .button').removeClass('hover');
    }
  }

  function onHandleFilter (event) {

    $.ajax({
      type: "GET",
      url: "/manager/service-management/filter",
      data: {
        filter: {
        room_id_filter: document.querySelectorAll('input[name=room_name_filter]')[0].value,
        status_filter: document.querySelectorAll('input[name=status_filter]')[0].value,
        month_filter: document.getElementById("month_filter").value,
        min_charge: document.querySelectorAll('input[name=min_charge]')[0].value,
        max_charge: document.querySelectorAll('input[name=max_charge]')[0].value,
        }
      },
      success: function(result){
        console.log("filter success")
        $('#service_charge_table').html(result)
        console.log(event.name)
          if (event.name == "status_filter" & event.value == 'UNPAID') {
            $('.checkbox_col').css("display", "block");
          }
          else if (event.name == "status" & event.value == 'PAID') {
            $('.checkbox_col').css("display", "none");
          }
      },
      error: function (error) {

      }
    })
   
    document.querySelectorAll('#max_charge .item').forEach(item => {
      item.classList.remove("disabled")
      if(parseInt(document.querySelectorAll("input[name=min_charge]")[0].value) != 0 ){
        if (parseInt(item.textContent) <= parseInt(document.querySelectorAll("input[name=min_charge]")[0].value)) {
          item.classList.add("disabled")
        } 
      }
    })

    document.querySelectorAll('#min_charge .item').forEach(item => {
      item.classList.remove("disabled")
      if(parseInt(document.querySelectorAll("input[name=max_charge]")[0].value)){
        if (parseInt(item.textContent) >= parseInt(document.querySelectorAll("input[name=max_charge]")[0].value)) {
          item.classList.add("disabled")
        }
      }
    })
  }

  function onclick() {
    console.log(123)
  }


  $('.second.modal')
    .modal('attach events', '.first.modal .button.edit');

  $('.ui.dropdown')
  .dropdown();


  function changePrice() {
    $('#total_price_edit_field').val(parseInt($('#electricity_price_edit_field').val()) + parseInt($('#water_price_edit_field').val()))
  }
  function showServiceChargeInfo(room_id, year, month, charge_id, index ){
    $('.ui.modal.first.service_charge_info').modal('show');
    $('#service_charge_edit_form').form('reset');
    $("#service_charge_edit_form").find('.error').removeClass('error');
    $.ajax({
      type: "POST",
      url: `/manager/service-management/${charge_id}/${year}/${month}`,
      data: {
        "charge_id": charge_id
      },
      success: function(result){
        console.log(result)
        //Show modal
        $('#show_month').html(result.service_charge.month)
        $('#show_year').html(result.service_charge.year)
        $('#show_water_price').html(result.service_charge.water_price)
        $('#show_electricity_price').html(result.service_charge.electricity_price)
        $('#show_total_price').html(result.service_charge.total_price)
        $('#show_payer').html(result.service_charge.payer)
        $('#show_status').html(result.service_charge.status)
        $('#show_paid_at').html(result.service_charge.paid_at.split('T')[0].split('-').reverse().join('/'))
        $('.show_room_name').html(result.room.room_name)
        $('#room_id').val(result.room.id)
        $('#charge_id').val(result.service_charge.id)
        // console.log(result.room)
        //Edit modal
        $('#month_edit_field').val(result.service_charge.month)
        $('#year_edit_field').val(result.service_charge.year)
        $('#water_price_edit_field').val(result.service_charge.water_price)
        $('#electricity_price_edit_field').val(result.service_charge.electricity_price)
        $('#total_price_edit_field').val(result.service_charge.total_price)
        $('#status_edit_field').val(result.service_charge.status)
        $('#payer_edit_field').val(result.service_charge.payer)
        $('#paid_at').html(result.service_charge.paid_at.split('T')[0].split('-').reverse().join('/'))
        $('#selected_item').html(result.service_charge.status)
        $('#charge_index').val(index)

        // $('#status_edit_field').val()
      },
      error: function (error) {
        console.log(error)
      }
    })
  }

  function submitUpdateServiceCharge(e){
    let room_id = $('#room_id').val()
    let year = $('#year_edit_field').val();
    let month = $('#month_edit_field').val();
    let charge_id = $('#charge_id').val();
    console.log("room_id: " + room_id)
    // $('#service_charge_edit_form').form('reset');
    $("#service_charge_edit_form").find('.error').removeClass('error');
    $('#show_info_modal').modal('hide');
    $('#edit_info_modal').modal('hide');
    e.preventDefault();
    $.ajax({
      type: "POST",
      url: `/manager/service-management/${charge_id}/${year}/${month}/update`,
      data: {
        service_charge: {
          "charge_id": charge_id,
          "water_price": $('#water_price_edit_field').val(),
          "electricity_price": $('#electricity_price_edit_field').val(),
          "total_price": $('#total_price_edit_field').val(),
          "month": $('#month_edit_field').val(),
          "year": $('#year_edit_field').val(),
          "payer": $('#payer_edit_field').val(),
          "status": $('#status_edit_field').val(),
          "index": $('#charge_index').val()
        }
      },
      success: function(result){
        console.log(result)
        $(`#tr_service_charge_${charge_id}`).html(result)
      },
      error: function (error) {}
    })
  }

  $('#service_charge_edit_form').off('submit').submit(function(e){
    if($('#service_charge_edit_form').form('is valid')){
      console.log("submit")

      submitUpdateServiceCharge(e);
    }
  })

  $('.second.modal')
    .modal('attach events', '.first.modal .button.edit');

    $('#service_charge_edit_form')
    .form({
      fields: {
        electricity_price: {
          identifier: 'electricity_price',
          rules: [
            {
              type: 'empty',
              prompt: 'Please enter student name!!'
            },
            {
              type: 'integer[0..1000000000000]',
              prompt: 'Electricity_price must be more than 0 vnd and less than 1000000000000 vnd!!'
            }
          ]
        },
        status: {
          identifier: 'status',
          rules: [
            {
              type: 'empty',
              prompt: 'Please setting status!!'
            }
          ]
        },
        total_price: {
          identifier: 'total_price',
          rules: [
            {
              type: 'empty',
              prompt: 'Please enter student name!!'
            },
            {
              type: 'integer[0..1000000000000]',
              prompt: 'Total price must be more than 0 vnd and less than 1000000000000 vnd!!'
            }
          ]
        },
        water_price: {
          identifier: 'water_price',
          rules: [
            {
              type: 'empty',
              prompt: 'Please enter student name!!'
            },
            {
              type: 'integer[0..1000000000000]',
              prompt: 'Water price must be more than 0 vnd and less than 1000000000000 vnd!!'
            }
          ]
        },
        payer: {
          identifier: 'payer',
          rules: [
            {
              type: 'empty',
              prompt: 'Please enter payer!!'
            },
            {
              type: 'minLength[1]',
              prompt: 'Title must be more than 1 letters!'
            },
            {
              type: 'maxLength[10]',
              prompt: 'Title must be less than 100 letters!'
            }
          ]
        }
      },
      inline: true,
      on: 'blur'
    })
  ;
  function closeModal() {
    $("#service_charge_edit_form").find('.error').removeClass('error');
    $('#show_info_modal').modal('hide');
    $('#edit_info_modal').modal('hide');
  }

  // search

  $(document).on("turbolinks:load", function() {
    $(".search-service-charge-form").on("keyup", function() {
      // $('#room_list').html("")
      $.ajax({
        type: "GET",
        url: "/manager/service-management/find?q=" + this.value,
        success: function(result){
          $('#service_charge_table').html(result)
          console.log('success' + result)
        },
        error: function (error){
          console.log('error', error)
        }
      })
    });
  });
</script>